# Documentaci√≥n de Funciones - M√≥dulo Movimientos

Esta documentaci√≥n detalla todas las funciones utilizadas en la estructura modularizada del m√≥dulo de movimientos, explicando qu√© hace cada una y c√≥mo se relacionan entre s√≠.

---

## üìÇ **index.js** - Orquestador Principal

### `initMovimientos()`
**Tipo:** `async function`
**Par√°metros:** Ninguno
**Retorna:** `Promise<void>`

**Prop√≥sito:** Punto de entrada del m√≥dulo. Orquesta la inicializaci√≥n de todos los componentes.

**Acciones:**
1. ‚úÖ Crea la tabla principal de movimientos con Tabulator
2. ‚úÖ Configura el sistema de b√∫squeda con debounce
3. ‚úÖ Inicializa los botones del toolbar (crear, editar, eliminar, refrescar)
4. ‚úÖ Configura los eventos de clic en las filas para mostrar detalles
5. ‚úÖ Inicializa el modal de b√∫squeda de clientes
6. ‚úÖ Ajusta las alturas del panel de detalles
7. ‚úÖ Configura listener para ajustar alturas al redimensionar ventana

**Uso:**
```javascript
import { initMovimientos } from './modules/movimientos/index.js';
await initMovimientos();
```

---

## üìä **state.js** - Gesti√≥n de Estado

### `selectedRowData()`
**Tipo:** `function`
**Par√°metros:** Ninguno
**Retorna:** `Object|null`

**Prop√≥sito:** Obtiene los datos de la fila actualmente seleccionada.

**Uso:**
```javascript
import { selectedRowData } from './state.js';
const rowData = selectedRowData();
if (rowData) {
  console.log('Movimiento seleccionado:', rowData.docto);
}
```

### `setSelectedRowData(data)`
**Tipo:** `function`
**Par√°metros:**
- `data` (Object|null) - Datos de la fila a establecer, o null para limpiar

**Retorna:** `Object|null`

**Prop√≥sito:** Establece los datos de la fila seleccionada en el estado compartido.

**Uso:**
```javascript
import { setSelectedRowData } from './state.js';

// Establecer selecci√≥n
setSelectedRowData({ docto: '12345', fecha: '2025-01-01', ... });

// Limpiar selecci√≥n
setSelectedRowData(null);
```

---

## üóÇÔ∏è **movimientosTable.js** - Tabla Principal

### `createMovimientosTable()`
**Tipo:** `function`
**Par√°metros:** Ninguno
**Retorna:** `Tabulator` (instancia)

**Prop√≥sito:** Crea y configura la tabla principal de movimientos usando Tabulator.

**Caracter√≠sticas:**
- ‚úÖ Paginaci√≥n remota desde el servidor
- ‚úÖ Columnas: C√≥digo, Cliente, Fecha
- ‚úÖ Normalizaci√≥n autom√°tica de datos de terceros
- ‚úÖ Formato de fechas (YYYY-MM-DD)
- ‚úÖ Selecci√≥n de una fila a la vez
- ‚úÖ Manejo de errores AJAX

**Configuraci√≥n destacada:**
```javascript
// Normalizaci√≥n de datos en ajaxResponse
ajaxResponse: function (url, params, response) {
    const rows = response.data || [];
    return rows.map((r) => {
        // Normaliza nombre_tercero y codcli
        r.nombre_tercero = r.nombre_tercero ||
                          (r.tercero?.Nombre_tercero) ||
                          r.nomcomer || '';
        r.codcli = r.codcli ||
                  (r.tercero?.codcli) ||
                  r.nit_tercero || '';
        return r;
    });
}
```

**Uso:**
```javascript
import { createMovimientosTable } from './movimientosTable.js';
const table = createMovimientosTable();
```

---

## üîç **search.js** - Sistema de B√∫squeda

### `setupSearch(table)`
**Tipo:** `function`
**Par√°metros:**
- `table` (Tabulator) - Instancia de la tabla de movimientos

**Retorna:** `void`

**Prop√≥sito:** Configura el sistema de b√∫squeda de movimientos.

**Caracter√≠sticas:**
- ‚úÖ B√∫squeda con debounce de 350ms
- ‚úÖ Bot√≥n de limpiar b√∫squeda
- ‚úÖ Limpia la selecci√≥n al buscar
- ‚úÖ Resetea a primera p√°gina

**Funci√≥n interna: `applySearch(term)`**
- Limpia espacios del t√©rmino
- Recarga datos con nuevo t√©rmino
- Resetea a p√°gina 1
- Limpia selecci√≥n actual

**Uso:**
```javascript
import { setupSearch } from './search.js';
setupSearch(table);
```

---

## üõ†Ô∏è **toolbar.js** - Botones de Acci√≥n

### `setupToolbar(table)`
**Tipo:** `function`
**Par√°metros:**
- `table` (Tabulator) - Instancia de la tabla de movimientos

**Retorna:** `Object { updateToolbarState }`

**Prop√≥sito:** Configura el toolbar de movimientos y gestiona el estado de los botones.

**Botones gestionados:**
1. **Crear** - Siempre habilitado
2. **Editar** - Habilitado solo con selecci√≥n
3. **Eliminar** - Habilitado solo con selecci√≥n
4. **Refrescar** - Siempre habilitado

**Funci√≥n retornada: `updateToolbarState()`**
- Habilita/deshabilita botones seg√∫n selecci√≥n
- Llamada desde otros m√≥dulos (detail.js)

**Bot√≥n Editar - Acciones:**
1. Valida selecci√≥n
2. Carga c√≥digo de cliente
3. Entra en modo edici√≥n
4. Muestra panel de detalles

**Uso:**
```javascript
import { setupToolbar } from './toolbar.js';
const { updateToolbarState } = setupToolbar(table);
// Luego puedes llamar updateToolbarState() cuando cambies la selecci√≥n
```

---

## üìã **detail.js** - Panel de Detalles

### `setupRowClick(table, updateToolbarStateFn)`
**Tipo:** `function`
**Par√°metros:**
- `table` (Tabulator) - Instancia de la tabla de movimientos
- `updateToolbarStateFn` (Function) - Funci√≥n para actualizar toolbar

**Retorna:** `void`

**Prop√≥sito:** Configura el evento de clic en filas para mostrar detalles.

**Flujo al hacer clic en una fila:**
1. ‚úÖ Sale del modo edici√≥n
2. ‚úÖ Actualiza la selecci√≥n
3. ‚úÖ Carga fecha del movimiento
4. ‚úÖ Carga n√∫mero de orden
5. ‚úÖ Carga informaci√≥n del cliente (normalizada)
6. ‚úÖ Obtiene cilindros del backend
7. ‚úÖ Renderiza tabla de cilindros
8. ‚úÖ Muestra panel de detalles
9. ‚úÖ Actualiza estado del toolbar

**Normalizaci√≥n de datos de cliente:**
```javascript
// Busca en m√∫ltiples ubicaciones
const codcli = data.codcli ||
              (data.tercero?.codcli) ||
              data.nit_tercero || '';

const nombreCliente = data.nombre_tercero ||
                     (data.tercero?.Nombre_tercero) ||
                     data.nomcomer || '';
```

**Uso:**
```javascript
import { setupRowClick } from './detail.js';
setupRowClick(table, updateToolbarState);
```

---

## üîß **cilindrosTable.js** - Tabla de Cilindros

### `renderCilindrosTabulator(bodies)`
**Tipo:** `function`
**Par√°metros:**
- `bodies` (Array<Object>) - Array de cilindros del movimiento
  - `codigo_articulo` (string) - C√≥digo del cilindro
  - `cantidad` (number) - Cantidad
  - `precio_docto` (number) - Precio

**Retorna:** `void`

**Prop√≥sito:** Renderiza la tabla de cilindros para un movimiento seleccionado.

**Caracter√≠sticas:**
- ‚úÖ Destruye tabla anterior (previene memory leaks)
- ‚úÖ Altura responsiva (184px desktop, 150px m√≥vil)
- ‚úÖ Columnas: C√≥digo, Cantidad, Precio
- ‚úÖ Sin paginaci√≥n (muestra todos)
- ‚úÖ Mensaje si no hay cilindros

**Uso:**
```javascript
import { renderCilindrosTabulator } from './cilindrosTable.js';

const cilindros = [
  { codigo_articulo: 'CIL001', cantidad: 5, precio_docto: 1500 },
  { codigo_articulo: 'CIL002', cantidad: 3, precio_docto: 2000 }
];
renderCilindrosTabulator(cilindros);
```

---

## üî® **utils.js** - Funciones Auxiliares

### `syncDetailHeights()`
**Tipo:** `function`
**Par√°metros:** Ninguno
**Retorna:** `void`

**Prop√≥sito:** Sincroniza las alturas del panel de detalles.

**Acci√≥n:** Establece `minHeight: 365px` en el placeholder para evitar saltos visuales.

**Uso:**
```javascript
import { syncDetailHeights } from './utils.js';
syncDetailHeights();
```

---

### `enterEditMode()`
**Tipo:** `function`
**Par√°metros:** Ninguno
**Retorna:** `void`

**Prop√≥sito:** Activa el modo de edici√≥n del movimiento.

**Acciones:**
1. ‚úÖ Busca wrappers ocultos de campos cliente y cilindro
2. ‚úÖ Los marca con `data-was-hidden="true"`
3. ‚úÖ Remueve clase "hidden" para mostrarlos
4. ‚úÖ Hace campo cliente editable
5. ‚úÖ Enfoca campo cilindro

**Funci√≥n interna: `toggleWrapper(id)`**
- Busca wrapper padre oculto
- Lo marca para restauraci√≥n
- Lo muestra

**Uso:**
```javascript
import { enterEditMode } from './utils.js';
enterEditMode();
```

---

### `exitEditMode()`
**Tipo:** `function`
**Par√°metros:** Ninguno
**Retorna:** `void`

**Prop√≥sito:** Desactiva el modo de edici√≥n.

**Acciones:**
1. ‚úÖ Busca elementos con `data-was-hidden="true"`
2. ‚úÖ Les agrega clase "hidden"
3. ‚úÖ Remueve atributo `data-was-hidden`
4. ‚úÖ Campo cliente a solo lectura
5. ‚úÖ Quita foco de campo cilindro

**Uso:**
```javascript
import { exitEditMode } from './utils.js';
exitEditMode();
```

---

### `showMovimientoDetalle()`
**Tipo:** `function`
**Par√°metros:** Ninguno
**Retorna:** `void`

**Prop√≥sito:** Muestra el panel de detalles del movimiento.

**Acciones:**
1. ‚úÖ Muestra formulario de detalles
2. ‚úÖ Muestra contenedor de cilindros
3. ‚úÖ Oculta placeholder
4. ‚úÖ Oculta t√≠tulos de ayuda
5. ‚úÖ Sincroniza alturas

**Uso:**
```javascript
import { showMovimientoDetalle } from './utils.js';
showMovimientoDetalle();
```

---

## üë• **clientesModal.js** - Modal de Clientes

### `setupClientesModal()`
**Tipo:** `function`
**Par√°metros:** Ninguno
**Retorna:** `void`

**Prop√≥sito:** Configura el modal de b√∫squeda y selecci√≥n de clientes.

**Caracter√≠sticas:**
- ‚úÖ Carga lista de clientes desde `/terceros`
- ‚úÖ Tabla Tabulator con columnas: C√≥digo, Nombre
- ‚úÖ Selecci√≥n por clic
- ‚úÖ Autocompletar campos del formulario
- ‚úÖ Cierre por bot√≥n o clic fuera

**Flujo al abrir modal:**
1. Muestra el modal
2. Carga clientes desde servidor
3. Destruye tabla anterior si existe
4. Crea nueva tabla Tabulator
5. Configura evento de selecci√≥n

**Flujo al seleccionar cliente:**
1. Obtiene datos del cliente
2. Llena campo de c√≥digo
3. Llena campo de informaci√≥n
4. Cierra modal autom√°ticamente

**Eventos configurados:**
- **rowClick** - Selecciona cliente y cierra modal
- **cerrarClienteModal click** - Cierra sin seleccionar
- **clienteModal click (overlay)** - Cierra si clic fuera del contenido

**Uso:**
```javascript
import { setupClientesModal } from './clientesModal.js';
setupClientesModal();
```

---

## üîÑ Flujo de Datos Entre Funciones

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ initMovimientos()                       ‚îÇ ‚Üê Punto de entrada
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
               ‚îÇ
               ‚îú‚îÄ‚Üí createMovimientosTable() ‚Üí Tabla principal
               ‚îÇ   ‚îî‚îÄ‚Üí ajaxResponse() ‚Üí Normaliza datos
               ‚îÇ
               ‚îú‚îÄ‚Üí setupSearch(table)
               ‚îÇ   ‚îú‚îÄ‚Üí applySearch() ‚Üí Recarga datos
               ‚îÇ   ‚îî‚îÄ‚Üí setSelectedRowData(null) ‚Üí Limpia estado
               ‚îÇ
               ‚îú‚îÄ‚Üí setupToolbar(table)
               ‚îÇ   ‚îú‚îÄ‚Üí updateToolbarState() ‚Üí Habilita/deshabilita botones
               ‚îÇ   ‚îú‚îÄ‚Üí enterEditMode() ‚Üí Modo edici√≥n
               ‚îÇ   ‚îî‚îÄ‚Üí showMovimientoDetalle() ‚Üí Muestra panel
               ‚îÇ
               ‚îú‚îÄ‚Üí setupRowClick(table, updateToolbarState)
               ‚îÇ   ‚îú‚îÄ‚Üí exitEditMode() ‚Üí Sale de edici√≥n
               ‚îÇ   ‚îú‚îÄ‚Üí setSelectedRowData(data) ‚Üí Guarda selecci√≥n
               ‚îÇ   ‚îú‚îÄ‚Üí fetch(/movimientos/{docto}) ‚Üí Obtiene cilindros
               ‚îÇ   ‚îú‚îÄ‚Üí renderCilindrosTabulator() ‚Üí Tabla cilindros
               ‚îÇ   ‚îú‚îÄ‚Üí showMovimientoDetalle() ‚Üí Muestra detalles
               ‚îÇ   ‚îî‚îÄ‚Üí updateToolbarStateFn() ‚Üí Actualiza toolbar
               ‚îÇ
               ‚îú‚îÄ‚Üí setupClientesModal()
               ‚îÇ   ‚îú‚îÄ‚Üí fetch(/terceros) ‚Üí Carga clientes
               ‚îÇ   ‚îî‚îÄ‚Üí Tabulator ‚Üí Tabla modal
               ‚îÇ
               ‚îî‚îÄ‚Üí syncDetailHeights() ‚Üí Ajusta alturas
```

---

## üì¶ Dependencias Entre M√≥dulos

```
index.js
  ‚Üì
  ‚îú‚îÄ‚îÄ movimientosTable.js (Tabulator)
  ‚îú‚îÄ‚îÄ search.js ‚Üí utils.js (debounce), state.js
  ‚îú‚îÄ‚îÄ toolbar.js ‚Üí utils.js, state.js
  ‚îú‚îÄ‚îÄ detail.js ‚Üí cilindrosTable.js, state.js, utils.js
  ‚îú‚îÄ‚îÄ clientesModal.js (Tabulator)
  ‚îî‚îÄ‚îÄ utils.js
```

---

## üéØ Resumen de Responsabilidades

| M√≥dulo | Responsabilidad Principal | Funciones Exportadas |
|--------|---------------------------|---------------------|
| **index.js** | Orquestaci√≥n | `initMovimientos()` |
| **state.js** | Estado compartido | `selectedRowData()`, `setSelectedRowData()` |
| **movimientosTable.js** | Tabla principal | `createMovimientosTable()` |
| **cilindrosTable.js** | Tabla cilindros | `renderCilindrosTabulator()` |
| **search.js** | B√∫squeda | `setupSearch()` |
| **toolbar.js** | Botones acci√≥n | `setupToolbar()` |
| **detail.js** | Panel detalles | `setupRowClick()` |
| **clientesModal.js** | Modal clientes | `setupClientesModal()` |
| **utils.js** | Utilidades | `syncDetailHeights()`, `enterEditMode()`, `exitEditMode()`, `showMovimientoDetalle()` |

---

## üîê Variables Privadas

### state.js
- `_selectedRowData` - Datos de fila seleccionada (privada)

### cilindrosTable.js
- `cilindrosTabulator` - Instancia de tabla cilindros (privada)

### clientesModal.js
- `clientesTabulator` - Instancia de tabla clientes (privada)

---

## üìö Convenciones Utilizadas

1. **JSDoc** - Documentaci√≥n est√°ndar de JavaScript
2. **Nombres descriptivos** - Funciones y variables autoexplicativas
3. **Comentarios inline** - Explicaciones paso a paso
4. **Modularidad** - Una responsabilidad por m√≥dulo
5. **Encapsulaci√≥n** - Variables privadas con closure
6. **Exports nombrados** - Facilita tree-shaking

---

## üöÄ Pr√≥ximos Pasos

Para mejorar a√∫n m√°s la documentaci√≥n:

1. ‚úÖ Agregar ejemplos de uso completos
2. ‚úÖ Documentar tipos con TypeScript (opcional)
3. ‚úÖ Crear tests unitarios
4. ‚úÖ Agregar diagramas de secuencia
5. ‚úÖ Documentar APIs del backend

---

**Fecha de √∫ltima actualizaci√≥n:** Octubre 1, 2025
**Versi√≥n:** 1.0.0
**Autor:** Sistema Modularizado de Movimientos
